<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - PROFIT GAINER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/investments.css">
  <style>
    .admin-stat-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
      transition: transform 0.3s;
    }
    .admin-stat-card:hover {
      transform: translateY(-5px);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 15px;
    }
  </style>
</head>
<body>

  <!-- Sidebar (desktop) -->
  <aside class="sidebar d-none d-md-flex">
    <div class="sidebar-header text-center mb-4">
      <h2><i class="fa-solid fa-coins text-warning"></i> PROFIT GAINER</h2>
    </div>
    <ul class="sidebar-menu list-unstyled">
      <li><a href="/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a></li>
      <li><a href="/profile"><i class="fa-solid fa-user"></i> Profile</a></li>
      <li><a href="/deposits"><i class="fa-solid fa-wallet"></i> Deposits</a></li>
      <li><a href="/wallet"><i class="fa-solid fa-money-bill-transfer"></i> Wallet</a></li>
      <li><a href="/applyFunds"><i class="fa-solid fa-hand-holding-dollar"></i> Apply Funds</a></li>
      <li><a href="/investments"><i class="fa-solid fa-briefcase"></i> Invest</a></li>
      <li><a href="/support"><i class="fa-solid fa-headset"></i> Support</a></li>
      <li><a href="/admin" class="active text-danger"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a></li>
      <li><a class="text-danger" href="/logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
    </ul>
  </aside>

  <!-- Mobile Menu -->
  <header class="d-md-none">
    <nav class="navbar navbar-dark glass-nav py-2 fixed-top">
      <div class="container-fluid d-flex justify-content-between align-items-center">
        <h6 class="mb-0 text-warning fw-bold text-truncate d-flex align-items-center">
          <i class="fa-solid fa-coins me-2"></i> PROFIT GAINER
        </h6>
        <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start glass-nav text-white" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title"><i class="fa-solid fa-coins text-warning"></i> PROFIT GAINER</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="mobile-nav list-unstyled">
          <li><a href="/dashboard" class="nav-link"><i class="fa-solid fa-chart-line"></i> Dashboard</a></li>
          <li><a href="/profile" class="nav-link"><i class="fa-solid fa-user"></i> Profile</a></li>
          <li><a href="/deposits" class="nav-link"><i class="fa-solid fa-wallet"></i> Deposits</a></li>
          <li><a href="/wallet" class="nav-link"><i class="fa-solid fa-money-bill-transfer"></i> Wallet</a></li>
          <li><a href="/applyFunds" class="nav-link"><i class="fa-solid fa-hand-holding-dollar"></i> Apply Funds</a></li>
          <li><a href="/investments" class="nav-link"><i class="fa-solid fa-briefcase"></i> Invest</a></li>
          <li><a href="/support" class="nav-link"><i class="fa-solid fa-headset"></i> Support</a></li>
          <li><a href="/admin" class="nav-link active text-danger"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a></li>
          <li><a href="/logout" class="nav-link text-danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <header class="main-header text-center mb-4">
      <h1 class="text-danger"><i class="fa-solid fa-shield-halved"></i> Admin Dashboard</h1>
      <p>Platform overview • User management • Deposit confirmation • Activity monitoring</p>
    </header>

    <!-- Flash Messages -->
    <div class="container mb-4">
      <% if (success && success.length > 0) { %>
        <% success.forEach(message => { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% }) %>
      <% } %>
      <% if (error && error.length > 0) { %>
        <% error.forEach(message => { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% }) %>
      <% } %>
    </div>

    <div class="container py-4">
      <!-- Platform Stats -->
      <div class="row g-4 mb-5 justify-content-center">
        <div class="col-lg-3 col-md-6 d-flex">
          <div class="admin-stat-card p-4 text-center flex-fill shadow">
            <i class="fa-solid fa-users fa-3x text-primary mb-3"></i>
            <h4>Total Users</h4>
            <h2><%= stats.totalUsers %></h2>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 d-flex">
          <div class="admin-stat-card p-4 text-center flex-fill shadow">
            <i class="fa-solid fa-wallet fa-3x text-info mb-3"></i>
            <h4>Total Wallet Balance</h4>
            <h2>$<%= Number(stats.totalWalletBalance).toLocaleString() %></h2>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 d-flex">
          <div class="admin-stat-card p-4 text-center flex-fill shadow">
            <i class="fa-solid fa-coins fa-3x text-warning mb-3"></i>
            <h4>Total Invested</h4>
            <h2>$<%= Number(stats.totalInvested).toLocaleString() %></h2>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 d-flex">
          <div class="admin-stat-card p-4 text-center flex-fill shadow">
            <i class="fa-solid fa-chart-line fa-3x text-success mb-3"></i>
            <h4>Total Platform Profit</h4>
            <h2>$<%= Number(stats.totalProfit).toLocaleString() %></h2>
          </div>
        </div>
      </div>

      <!-- Deposit Management -->
      <div class="glass-card p-4 mb-5 shadow">
        <h3 class="mb-4 text-primary"><i class="fa-solid fa-money-bill-transfer"></i> Deposit Confirmation Center</h3>

        <!-- Pending Deposits -->
        <% if (pendingDeposits && pendingDeposits.length > 0) { %>
          <h5 class="text-danger mb-3">
            <i class="fa-solid fa-exclamation-triangle"></i> 
            Pending Approval (<%= pendingDeposits.length %>)
          </h5>
          <div class="table-responsive mb-5">
            <table class="table table-dark table-hover align-middle">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Proof</th>
                  <th>Submitted</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% pendingDeposits.forEach(d => { %>
                  <tr class="table-warning">
                    <td><strong><%= d.full_name %></strong></td>
                    <td class="text-success fw-bold">$<%= Number(d.amount).toLocaleString() %></td>
                    <td>
                      <% if (d.proof_image) { %>
                        <a href="/uploads/<%= d.proof_image %>" target="_blank" class="btn btn-info btn-sm">
                          <i class="fa-solid fa-image"></i> View Proof
                        </a>
                      <% } else { %>
                        <span class="text-muted">No proof uploaded</span>
                      <% } %>
                    </td>
                    <td><%= new Date(d.created_at).toLocaleString() %></td>
                    <td>
                      <form action="/admin/approve-deposit/<%= d.id %>" method="POST" class="d-inline me-2">
                        <button class="btn btn-success btn-sm" type="submit">
                          <i class="fa-solid fa-check"></i> Approve & Credit
                        </button>
                      </form>
                      <form action="/admin/reject-deposit/<%= d.id %>" method="POST" class="d-inline">
                        <input type="hidden" name="reason" value="Invalid proof or details">
                        <button class="btn btn-danger btn-sm" type="submit" onclick="return confirm('Reject this deposit? User will not be credited.')">
                          <i class="fa-solid fa-x"></i> Reject
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-success mb-4">
            <i class="fa-solid fa-check-circle"></i> No pending deposits — all processed!
          </div>
        <% } %>

        <!-- Deposit History -->
        <h5 class="mt-5 mb-3">Deposit History (Last 50)</h5>
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle">
            <thead>
              <tr>
                <th>User</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Processed</th>
                <th>Submitted</th>
              </tr>
            </thead>
            <tbody>
              <% if (allDeposits && allDeposits.length > 0) { %>
                <% allDeposits.forEach(d => { %>
                  <tr>
                    <td><%= d.full_name %></td>
                    <td>$<%= Number(d.amount).toLocaleString() %></td>
                    <td>
                      <span class="badge <%= d.status === 'approved' ? 'bg-success' : d.status === 'rejected' ? 'bg-danger' : 'bg-warning' %>">
                        <%= d.status.toUpperCase() %>
                      </span>
                    </td>
                    <td><%= d.processed_at ? new Date(d.processed_at).toLocaleDateString() : '-' %></td>
                    <td><%= new Date(d.created_at).toLocaleDateString() %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="5" class="text-center text-muted">No deposit history</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- All Registered Users -->
      <div class="glass-card p-4 mb-5 shadow">
        <h3 class="mb-4"><i class="fa-solid fa-users-gear"></i> All Registered Users</h3>
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Wallet Balance</th>
                <th>Joined Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (users.length > 0) { %>
                <% users.forEach(u => { %>
                  <tr>
                    <td><%= u.id %></td>
                    <td><strong><%= u.full_name %></strong></td>
                    <td><%= u.email %></td>
                    <td class="text-info">$<%= Number(u.balance).toLocaleString() %></td>
                    <td><%= new Date(u.created_at).toLocaleDateString() %></td>
                    <td>
                      <!-- Add Bonus -->
                      <form action="/admin/add-bonus" method="POST" class="d-inline">
                        <input type="hidden" name="user_id" value="<%= u.id %>">
                        <div class="input-group input-group-sm" style="width: 160px;">
                          <input type="number" name="amount" class="form-control" placeholder="Bonus $" min="0.01" step="0.01" required>
                          <button class="btn btn-success btn-sm" type="submit">Add</button>
                        </div>
                      </form>

                      <!-- Delete User -->
                      <form action="/admin/delete-user/<%= u.id %>" method="POST" class="d-inline ms-2"
                            onsubmit="return confirm('PERMANENTLY delete <%= u.full_name %> (ID: <%= u.id %>)? This cannot be undone!')">
                        <button class="btn btn-danger btn-sm" type="submit">
                          <i class="fa-solid fa-trash"></i> Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">No users found.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Investments -->
      <div class="glass-card p-4 shadow">
        <h3 class="mb-4"><i class="fa-solid fa-clock-rotate-left"></i> Recent Investments (Last 10)</h3>
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle">
            <thead>
              <tr>
                <th>User</th>
                <th>Asset</th>
                <th>Plan</th>
                <th>Amount</th>
                <th>Current Profit</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <% if (recentInvestments && recentInvestments.length > 0) { %>
                <% recentInvestments.forEach(inv => { %>
                  <tr>
                    <td><strong><%= inv.full_name %></strong></td>
                    <td><%= inv.asset_name %></td>
                    <td><%= inv.plan %></td>
                    <td>$<%= Number(inv.amount).toLocaleString() %></td>
                    <td class="<%= inv.profit >= 0 ? 'text-success' : 'text-danger' %>">
                      $<%= Number(inv.profit).toLocaleString() %>
                    </td>
                    <td><%= new Date(inv.created_at).toLocaleDateString() %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">No investments yet.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="footer text-center mt-5">
      <p>© 2026 Profit-Gainer Platform. All rights reserved.</p>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>